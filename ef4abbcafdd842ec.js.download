;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="a6d94eec-cdf2-613a-b5ea-0cbbddfeb109")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,761996,893299,846806,e=>{"use strict";(t=n||(n={}))[t.NONE=0]="NONE",t[t.SAMPLED=1]="SAMPLED",e.s(["TraceFlags",()=>n],893299);var t,n,i="0000000000000000",s="00000000000000000000000000000000",r={traceId:s,spanId:i,traceFlags:n.NONE};e.s(["INVALID_SPANID",()=>i,"INVALID_SPAN_CONTEXT",()=>r,"INVALID_TRACEID",()=>s],846806);var o=function(){function e(e){void 0===e&&(e=r),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.addLink=function(e){return this},e.prototype.addLinks=function(e){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}();e.s(["NonRecordingSpan",()=>o],761996)},548452,e=>{"use strict";var t=e.i(846806),n=e.i(761996),i=/^([0-9a-f]{32})$/i,s=/^[0-9a-f]{16}$/i;function r(e){return i.test(e)&&e!==t.INVALID_TRACEID}function o(e){var n;return r(e.traceId)&&(n=e.spanId,s.test(n)&&n!==t.INVALID_SPANID)}function a(e){return new n.NonRecordingSpan(e)}e.s(["isSpanContextValid",()=>o,"isValidTraceId",()=>r,"wrapSpanContext",()=>a])},783942,e=>{"use strict";var t="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:e.g,n="1.9.0",i=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/,s=function(e){var t=new Set([e]),n=new Set,s=e.match(i);if(!s)return function(){return!1};var r={major:+s[1],minor:+s[2],patch:+s[3],prerelease:s[4]};if(null!=r.prerelease)return function(t){return t===e};function o(e){return n.add(e),!1}return function(e){if(t.has(e))return!0;if(n.has(e))return!1;var s=e.match(i);if(!s)return o(e);var a={major:+s[1],minor:+s[2],patch:+s[3],prerelease:s[4]};if(null!=a.prerelease||r.major!==a.major)return o(e);if(0===r.major)return r.minor===a.minor&&r.patch<=a.patch?(t.add(e),!0):o(e);return r.minor<=a.minor?(t.add(e),!0):o(e)}}(n),r=Symbol.for("opentelemetry.js.api."+n.split(".")[0]);function o(e,i,s,o){void 0===o&&(o=!1);var a,c=t[r]=null!=(a=t[r])?a:{version:n};if(!o&&c[e]){var l=Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return s.error(l.stack||l.message),!1}if(c.version!==n){var l=Error("@opentelemetry/api: Registration of version v"+c.version+" for "+e+" does not match previously registered API v"+n);return s.error(l.stack||l.message),!1}return c[e]=i,s.debug("@opentelemetry/api: Registered a global for "+e+" v"+n+"."),!0}function a(e){var n,i,o=null==(n=t[r])?void 0:n.version;if(o&&s(o))return null==(i=t[r])?void 0:i[e]}function c(e,i){i.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+n+".");var s=t[r];s&&delete s[e]}e.s(["getGlobal",()=>a,"registerGlobal",()=>o,"unregisterGlobal",()=>c],783942)},945093,908564,e=>{"use strict";function t(e){return Symbol.for(e)}var n=new function e(t){var n=this;n._currentContext=t?new Map(t):new Map,n.getValue=function(e){return n._currentContext.get(e)},n.setValue=function(t,i){var s=new e(n._currentContext);return s._currentContext.set(t,i),s},n.deleteValue=function(t){var i=new e(n._currentContext);return i._currentContext.delete(t),i}};e.s(["ROOT_CONTEXT",()=>n,"createContextKey",()=>t],908564);var i=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},s=function(e,t,n){if(n||2==arguments.length)for(var i,s=0,r=t.length;s<r;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))},r=function(){function e(){}return e.prototype.active=function(){return n},e.prototype.with=function(e,t,n){for(var r=[],o=3;o<arguments.length;o++)r[o-3]=arguments[o];return t.call.apply(t,s([n],i(r),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}();e.s(["NoopContextManager",()=>r],945093)},40036,568126,883153,e=>{"use strict";var t,n,i=e.i(945093),s=e.i(783942),r=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},o=function(e,t,n){if(n||2==arguments.length)for(var i,s=0,r=t.length;s<r;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))},a=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c("verbose",this._namespace,e)},e}();function c(e,t,n){var i=(0,s.getGlobal)("diag");if(i)return n.unshift(t),i[e].apply(i,o([],r(n),!1))}(t=n||(n={}))[t.NONE=0]="NONE",t[t.ERROR=30]="ERROR",t[t.WARN=50]="WARN",t[t.INFO=60]="INFO",t[t.DEBUG=70]="DEBUG",t[t.VERBOSE=80]="VERBOSE",t[t.ALL=9999]="ALL",e.s(["DiagLogLevel",()=>n],568126);var l=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},h=function(e,t,n){if(n||2==arguments.length)for(var i,s=0,r=t.length;s<r;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))},d=function(){function e(){function e(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=(0,s.getGlobal)("diag");if(i)return i[e].apply(i,h([],l(t),!1))}}var t=this;t.setLogger=function(e,i){if(void 0===i&&(i={logLevel:n.INFO}),e===t){var r,o,a,c=Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!=(r=c.stack)?r:c.message),!1}"number"==typeof i&&(i={logLevel:i});var l=(0,s.getGlobal)("diag"),h=function(e,t){function i(n,i){var s=t[n];return"function"==typeof s&&e>=i?s.bind(t):function(){}}return e<n.NONE?e=n.NONE:e>n.ALL&&(e=n.ALL),t=t||{},{error:i("error",n.ERROR),warn:i("warn",n.WARN),info:i("info",n.INFO),debug:i("debug",n.DEBUG),verbose:i("verbose",n.VERBOSE)}}(null!=(o=i.logLevel)?o:n.INFO,e);if(l&&!i.suppressOverrideMessage){var d=null!=(a=Error().stack)?a:"<failed to generate stacktrace>";l.warn("Current logger will be overwritten from "+d),h.warn("Current logger will overwrite one already registered from "+d)}return(0,s.registerGlobal)("diag",h,t,!0)},t.disable=function(){(0,s.unregisterGlobal)("diag",t)},t.createComponentLogger=function(e){return new a(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}();e.s(["DiagAPI",()=>d],883153);var u=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},g=function(e,t,n){if(n||2==arguments.length)for(var i,s=0,r=t.length;s<r;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))},f="context",p=new i.NoopContextManager,y=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return(0,s.registerGlobal)(f,e,d.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,n){for(var i,s=[],r=3;r<arguments.length;r++)s[r-3]=arguments[r];return(i=this._getContextManager()).with.apply(i,g([e,t,n],u(s),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return(0,s.getGlobal)(f)||p},e.prototype.disable=function(){this._getContextManager().disable(),(0,s.unregisterGlobal)(f,d.instance())},e}();e.s(["ContextAPI",()=>y],40036)},136320,e=>{"use strict";var t=e.i(908564),n=e.i(761996),i=e.i(40036),s=(0,t.createContextKey)("OpenTelemetry Context Key SPAN");function r(e){return e.getValue(s)||void 0}function o(){return r(i.ContextAPI.getInstance().active())}function a(e,t){return e.setValue(s,t)}function c(e){return e.deleteValue(s)}function l(e,t){return a(e,new n.NonRecordingSpan(t))}function h(e){var t;return null==(t=r(e))?void 0:t.spanContext()}e.s(["deleteSpan",()=>c,"getActiveSpan",()=>o,"getSpan",()=>r,"getSpanContext",()=>h,"setSpan",()=>a,"setSpanContext",()=>l])},468930,e=>{"use strict";var t=e.i(783942),n=e.i(40036),i=e.i(136320),s=e.i(761996),r=e.i(548452),o=n.ContextAPI.getInstance(),a=function(){function e(){}return e.prototype.startSpan=function(e,t,n){if(void 0===n&&(n=o.active()),null==t?void 0:t.root)return new s.NonRecordingSpan;var a,c=n&&(0,i.getSpanContext)(n);return"object"==typeof(a=c)&&"string"==typeof a.spanId&&"string"==typeof a.traceId&&"number"==typeof a.traceFlags&&(0,r.isSpanContextValid)(c)?new s.NonRecordingSpan(c):new s.NonRecordingSpan},e.prototype.startActiveSpan=function(e,t,n,s){if(!(arguments.length<2)){2==arguments.length?c=t:3==arguments.length?(r=t,c=n):(r=t,a=n,c=s);var r,a,c,l=null!=a?a:o.active(),h=this.startSpan(e,r,l),d=(0,i.setSpan)(l,h);return o.with(d,c,void 0,h)}},e}(),c=new a,l=function(){function e(e,t,n,i){this._provider=e,this.name=t,this.version=n,this.options=i}return e.prototype.startSpan=function(e,t,n){return this._getTracer().startSpan(e,t,n)},e.prototype.startActiveSpan=function(e,t,n,i){var s=this._getTracer();return Reflect.apply(s.startActiveSpan,s,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):c},e}(),h=new(function(){function e(){}return e.prototype.getTracer=function(e,t,n){return new a},e}()),d=function(){function e(){}return e.prototype.getTracer=function(e,t,n){var i;return null!=(i=this.getDelegateTracer(e,t,n))?i:new l(this,e,t,n)},e.prototype.getDelegate=function(){var e;return null!=(e=this._delegate)?e:h},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,n){var i;return null==(i=this._delegate)?void 0:i.getTracer(e,t,n)},e}(),u=e.i(883153),g="trace",f=(function(){function e(){this._proxyTracerProvider=new d,this.wrapSpanContext=r.wrapSpanContext,this.isSpanContextValid=r.isSpanContextValid,this.deleteSpan=i.deleteSpan,this.getSpan=i.getSpan,this.getActiveSpan=i.getActiveSpan,this.getSpanContext=i.getSpanContext,this.setSpan=i.setSpan,this.setSpanContext=i.setSpanContext}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var n=(0,t.registerGlobal)(g,this._proxyTracerProvider,u.DiagAPI.instance());return n&&this._proxyTracerProvider.setDelegate(e),n},e.prototype.getTracerProvider=function(){return(0,t.getGlobal)(g)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){(0,t.unregisterGlobal)(g,u.DiagAPI.instance()),this._proxyTracerProvider=new d},e})().getInstance();e.s(["trace",()=>f],468930)},977195,590467,e=>{"use strict";let t=!0,n=!1,i=()=>{t=!0},s=()=>{t=!1},r=()=>window.addEventListener?(n||(window.addEventListener("online",i),window.addEventListener("offline",s),n=!0),()=>o()):()=>{},o=()=>{!window.removeEventListener||n&&(window.removeEventListener("online",i),window.removeEventListener("offline",s),n=!1)},a=()=>"u">typeof navigator,c=()=>{if(!a())throw Error("isBrowserOnline is not available on the server");return t};e.s(["canCheckIsOnline",()=>a,"isBrowserOnline",()=>c,"register",()=>r],590467),r(),e.s([],977195)},231693,e=>{"use strict";var t=e.i(40036).ContextAPI.getInstance();e.s(["context",()=>t])},164760,619379,e=>{"use strict";var t,n,i,s;(i=t||(t={}))[i.INTERNAL=0]="INTERNAL",i[i.SERVER=1]="SERVER",i[i.CLIENT=2]="CLIENT",i[i.PRODUCER=3]="PRODUCER",i[i.CONSUMER=4]="CONSUMER",e.s(["SpanKind",()=>t],164760),(s=n||(n={}))[s.UNSET=0]="UNSET",s[s.OK=1]="OK",s[s.ERROR=2]="ERROR",e.s(["SpanStatusCode",()=>n],619379)},364520,472278,e=>{"use strict";var t=e.i(783942),n=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),i={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},s={set:function(e,t,n){null!=e&&(e[t]=n)}},r=e.i(40036),o=(0,e.i(908564).createContextKey)("OpenTelemetry Baggage Key");function a(e){return e.getValue(o)||void 0}function c(){return a(r.ContextAPI.getInstance().active())}function l(e,t){return e.setValue(o,t)}function h(e){return e.deleteValue(o)}var d=e.i(883153),u=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o},g=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},f=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map(function(e){var t=u(e,2);return[t[0],t[1]]})},e.prototype.setEntry=function(t,n){var i=new e(this._entries);return i._entries.set(t,n),i},e.prototype.removeEntry=function(t){var n=new e(this._entries);return n._entries.delete(t),n},e.prototype.removeEntries=function(){for(var t,n,i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];var r=new e(this._entries);try{for(var o=g(i),a=o.next();!a.done;a=o.next()){var c=a.value;r._entries.delete(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},e.prototype.clear=function(){return new e},e}(),p=Symbol("BaggageEntryMetadata"),y=d.DiagAPI.instance();function m(e){return void 0===e&&(e={}),new f(new Map(Object.entries(e)))}function v(e){return"string"!=typeof e&&(y.error("Cannot create baggage metadata from unknown type: "+typeof e),e=""),{__TYPE__:p,toString:function(){return e}}}e.s(["baggageEntryMetadataFromString",()=>v,"createBaggage",()=>m],472278);var w="propagation",S=new n,b=(function(){function e(){this.createBaggage=m,this.getBaggage=a,this.getActiveBaggage=c,this.setBaggage=l,this.deleteBaggage=h}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return(0,t.registerGlobal)(w,e,d.DiagAPI.instance())},e.prototype.inject=function(e,t,n){return void 0===n&&(n=s),this._getGlobalPropagator().inject(e,t,n)},e.prototype.extract=function(e,t,n){return void 0===n&&(n=i),this._getGlobalPropagator().extract(e,t,n)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){(0,t.unregisterGlobal)(w,d.DiagAPI.instance())},e.prototype._getGlobalPropagator=function(){return(0,t.getGlobal)(w)||S},e})().getInstance();e.s(["propagation",()=>b],364520)},735744,e=>{"use strict";var t=e.i(389959);e.i(242933);var n=e.i(279606);e.i(925218);var i=e.i(112077),s=e.i(441329),r=e.i(479407);function o(){let e,o,a=(0,s.useIsInBonsaiWebview)(),c=(0,i.useCreateObservable)("u">typeof document&&"visible"===document.visibilityState),l=(e=(0,i.useCreateObservable)(null),o=(0,s.useIsInBonsaiWebview)(),(0,t.useEffect)(()=>{if(!o)return;let t=t=>(0,r.bonsaiActiveStateBridgeMessageHandler)(t,t=>{e.set("active"===t.state)});return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[o,e]),e),h=null!=l.current?l.current:c.current,d=(0,i.useCreateObservable)(h);return(0,t.useEffect)(()=>{let e=()=>{c.set("visible"===document.visibilityState)};document.addEventListener("visibilitychange",e);let t=n.Observable.combine(c,l).map(([e,t])=>null!=t?t:e).subscribe(e=>d.set(e));return()=>{document.removeEventListener("visibilitychange",e),t()}},[c,l,d,a]),d}e.s(["default",()=>o],735744)},227062,792129,500137,e=>{"use strict";let t;var n=e.i(960933),i=e.i(132592),s=e.i(50452),r=e.i(164760);e.i(619379);var o=e.i(231693),a=e.i(364520),c=e.i(468930),l=e.i(862927),h="UNEXPECTED_DISCONNECT",d="CANCEL",u=e=>n.Type.Object({ok:n.Type.Literal(!1),payload:e}),g=n.Type.Object({path:n.Type.String(),message:n.Type.String()});n.Type.Array(g);var f=n.Type.Object({code:n.Type.Literal(d),message:n.Type.String()});u(f);var p=n.Type.Union([n.Type.Object({code:n.Type.Literal("UNCAUGHT_ERROR"),message:n.Type.String()}),n.Type.Object({code:n.Type.Literal(h),message:n.Type.String()}),n.Type.Object({code:n.Type.Literal("INVALID_REQUEST"),message:n.Type.String(),extras:n.Type.Optional(n.Type.Object({firstValidationErrors:n.Type.Array(g),totalErrors:n.Type.Number()}))}),f]),y=u(p),m=n.Type.Union([n.Type.Object({ok:n.Type.Literal(!1),payload:n.Type.Object({code:n.Type.String(),message:n.Type.String(),extras:n.Type.Optional(n.Type.Unknown())})}),n.Type.Object({ok:n.Type.Literal(!0),payload:n.Type.Unknown()})]);function v(e){return{ok:!0,payload:e}}function w(e){return{ok:!1,payload:e}}var S={code:"READABLE_BROKEN",message:"Readable was broken before it is fully consumed"},b=class{closed=!1;locked=!1;broken=!1;brokenWithValuesLeftToRead=!1;queue=[];next=null;[Symbol.asyncIterator](){if(this.locked)throw TypeError("Readable is already locked");this.locked=!0;let e=!1;return{next:async()=>{if(e)return{done:!0,value:void 0};for(;0===this.queue.length;){if(this.closed&&!this.brokenWithValuesLeftToRead)return{done:!0,value:void 0};if(this.broken)return e=!0,{done:!1,value:w(S)};this.next||(this.next=function(){let e,t;return{promise:new Promise((n,i)=>{e=n,t=i}),resolve:e,reject:t}}()),await this.next.promise,this.next=null}return{done:!1,value:this.queue.shift()}},return:async()=>(this.break(),{done:!0,value:void 0})}}async collect(){let e=[];for await(let t of this)e.push(t);return e}break(){this.broken||(this.locked=!0,this.broken=!0,this.brokenWithValuesLeftToRead=this.queue.length>0,this.queue.length=0,this.next?.resolve())}isReadable(){return!this.locked&&!this.broken}_pushValue(e){if(!this.broken){if(this.closed)throw Error("Cannot push to closed Readable");this.queue.push(e),this.next?.resolve()}}_triggerClose(){if(this.closed)throw Error("Unexpected closing multiple times");this.closed=!0,this.next?.resolve()}_hasValuesInQueue(){return this.queue.length>0}isClosed(){return this.closed}},E=class{writeCb;closeCb;closed=!1;constructor(e){this.writeCb=e.writeCb,this.closeCb=e.closeCb}write(e){if(this.closed)throw Error("Cannot write to closed Writable");this.writeCb(e)}isWritable(){return!this.closed}close(e){this.closed||(void 0!==e&&this.writeCb(e),this.closed=!0,this.writeCb=()=>void 0,this.closeCb(),this.closeCb=()=>void 0)}isClosed(){return this.closed}},C=(0,s.customAlphabet)("1234567890abcdefghijklmnopqrstuvxyzABCDEFGHIJKLMNOPQRSTUVXYZ"),x=()=>C(12),T=n.Type.Object({type:n.Type.Literal("ACK")}),k=n.Type.Object({type:n.Type.Literal("CLOSE")}),I="v2.0",M=["v1.1",I];function B(e){return M.includes(e)}var L=n.Type.Object({type:n.Type.Literal("HANDSHAKE_REQ"),protocolVersion:n.Type.String(),sessionId:n.Type.String(),expectedSessionState:n.Type.Object({nextExpectedSeq:n.Type.Integer(),nextSentSeq:n.Type.Integer()}),metadata:n.Type.Optional(n.Type.Unknown())}),U=n.Type.Union([n.Type.Literal("SESSION_STATE_MISMATCH")]),_=n.Type.Union([n.Type.Literal("REJECTED_UNSUPPORTED_CLIENT"),n.Type.Literal("REJECTED_BY_CUSTOM_HANDLER")]),A=n.Type.Union([_,n.Type.Literal("MALFORMED_HANDSHAKE_META"),n.Type.Literal("MALFORMED_HANDSHAKE"),n.Type.Literal("PROTOCOL_VERSION_MISMATCH")]),D=n.Type.Union([U,A]),O=n.Type.Object({type:n.Type.Literal("HANDSHAKE_RESP"),status:n.Type.Union([n.Type.Object({ok:n.Type.Literal(!0),sessionId:n.Type.String()}),n.Type.Object({ok:n.Type.Literal(!1),reason:n.Type.String(),code:D})])});n.Type.Union([k,T,L,O]);var R=(t=n.Type.Unknown(),n.Type.Object({id:n.Type.String(),from:n.Type.String(),to:n.Type.String(),seq:n.Type.Integer(),ack:n.Type.Integer(),serviceName:n.Type.Optional(n.Type.String()),procedureName:n.Type.Optional(n.Type.String()),streamId:n.Type.String(),controlFlags:n.Type.Integer(),tracing:n.Type.Optional(n.Type.Object({traceparent:n.Type.String(),tracestate:n.Type.String()})),payload:t}));function N({from:e,to:t,sessionId:n,expectedSessionState:i,metadata:s,tracing:r}){return{id:x(),from:e,to:t,seq:0,ack:0,streamId:x(),controlFlags:0,tracing:r,payload:{type:"HANDSHAKE_REQ",protocolVersion:I,sessionId:n,expectedSessionState:i,metadata:s}}}function $({from:e,to:t,status:n}){return{id:x(),from:e,to:t,seq:0,ack:0,streamId:x(),controlFlags:0,payload:{type:"HANDSHAKE_RESP",status:n}}}function H(e){return(1&e)==1}function P(e){let t={traceparent:"",tracestate:""};return a.propagation.inject(e,t),t}function F(e,t,n,i,s){let r=s?a.propagation.extract(o.context.active(),s):o.context.active(),l=e.startSpan("river.session",{attributes:{component:"river","river.session.id":t,"river.session.to":n,"river.session.from":i}},r),h=c.trace.setSpan(r,l);return{span:l,ctx:h}}function V(e,t,n){let i=e.startSpan("river.connection",{attributes:{component:"river","river.connection.id":t.id},links:[{context:n.span.spanContext()}]},n.ctx),s=c.trace.setSpan(n.ctx,i);return{span:i,ctx:s}}function q(){return c.trace.getTracer("river",Q)}var j=()=>{},G={connectOnInvoke:!0,eagerlyConnect:!0};function z(e,t,n={}){n.handshakeOptions&&e.extendHandshake(n.handshakeOptions);let i={...G,...n};return i.eagerlyConnect&&e.connect(t),function e(t,n){return new Proxy(j,{get(i,s){if("string"==typeof s)return e(t,[...n,s])},apply:(e,i,s)=>t({path:n,args:s})})}(n=>{let[s,a,u]=[...n.path];if(!(s&&a&&u))throw Error("invalid river call, ensure the service and procedure you are calling exists");let[g,f]=n.args;if(i.connectOnInvoke&&!e.sessions.has(t)&&e.connect(t),"rpc"!==u&&"subscribe"!==u&&"stream"!==u&&"upload"!==u)throw Error(`invalid river call, unknown procedure type ${u}`);return function(e,t,n,i,s,a,u){var g,f;let p,v,S,C;if("closed"===t.getStatus()){let t,n,i;return f=e,t=new b,n=w({code:h,message:"transport is closed"}),t._pushValue(n),t._triggerClose(),(i=new E({writeCb:()=>{},closeCb:()=>{}})).close(),K(f,t,i)}let T=t.sessions.get(n)??t.createUnconnectedSession(n),I=t.getSessionBoundSendFn(n,T.id),M="rpc"===e||"subscription"===e,B=x(),{span:L,ctx:U}=(g=t.tracer,p=o.context.active(),v=g.startSpan(`river.client.${s}.${a}`,{attributes:{component:"river","river.method.kind":e,"river.method.service":s,"river.method.name":a,"river.streamId":B,"span.kind":"client"},links:[{context:T.telemetry.span.spanContext()}],kind:r.SpanKind.CLIENT},p),S=c.trace.setSpan(p,v),C={...T.loggingMetadata,transportMessage:{procedureName:a,serviceName:s}},v.isRecording()&&(C.telemetry={traceId:v.spanContext().traceId,spanId:v.spanContext().spanId}),T.log?.info(`invoked ${s}.${a}`,C),{span:v,ctx:S}),_=!0,A=new E({writeCb:e=>{I({streamId:B,payload:e,controlFlags:0})},closeCb:()=>{L.addEvent("reqWritable closed"),!M&&_&&I({streamId:B,controlFlags:8,payload:{type:"CLOSE"}}),D.isClosed()&&R()}}),D=new b,O=()=>{D._triggerClose(),L.addEvent("resReadable closed"),A.isClosed()&&R()};function R(){t.removeEventListener("message",$),t.removeEventListener("sessionStatus",H),u?.removeEventListener("abort",N),L.end()}function N(){!(D.isClosed()&&A.isClosed())&&(L.addEvent("sending cancel"),_=!1,D.isClosed()||(D._pushValue(w({code:d,message:"cancelled by client"})),O()),A.close(),I({streamId:B,controlFlags:4,payload:w({code:d,message:"cancelled by client"})}))}function $(e){if(e.streamId===B){if(e.to!==t.clientId)return void t.log?.error("got stream message from unexpected client",{clientId:t.clientId,transportMessage:e});if((4&e.controlFlags)==4){let n;_=!1,L.addEvent("received cancel"),l.Value.Check(y,e.payload)?n=e.payload:(n=w({code:d,message:"stream cancelled with invalid payload"}),t.log?.warn("got stream cancel without a valid protocol error",{clientId:t.clientId,transportMessage:e,validationErrors:[...l.Value.Errors(y,e.payload)]})),D.isClosed()||(D._pushValue(n),O()),A.close();return}if(D.isClosed()){L.recordException("received message after response stream is closed"),t.log?.error("received message after response stream is closed",{clientId:t.clientId,transportMessage:e});return}l.Value.Check(k,e.payload)||(l.Value.Check(m,e.payload)?D._pushValue(e.payload):t.log?.error("Got non-control payload, but was not a valid result",{clientId:t.clientId,transportMessage:e,validationErrors:[...l.Value.Errors(m,e.payload)]})),(8&e.controlFlags)==8&&(L.addEvent("received response close"),D.isClosed()?t.log?.error("received stream close but readable was already closed"):O())}}function H(e){"closing"===e.status&&e.session.to===n&&T.id===e.session.id&&(_=!1,D.isClosed()||(D._pushValue(w({code:h,message:`${n} unexpectedly disconnected`})),O()),A.close())}return u?.addEventListener("abort",N),t.addEventListener("message",$),t.addEventListener("sessionStatus",H),I({streamId:B,serviceName:s,procedureName:a,tracing:P(U),payload:i,controlFlags:M?10:2}),M&&A.close(),K(e,D,A,t.log)}("subscribe"===u?"subscription":u,e,t,g,s,a,f?f.signal:void 0)},[])}function K(e,t,n,i){if("subscription"===e)return{resReadable:t};if("rpc"===e)return W(t,i);if("upload"===e){let e=!1;return{reqWritable:n,finalize:()=>{if(e)throw Error("upload stream already finalized");return e=!0,n.isClosed()||n.close(),W(t,i)}}}return{resReadable:t,reqWritable:n}}async function W(e,t){let n=await e.collect();return n.length>1&&t?.error("Expected single message from server, got multiple"),n[0]}function X(e){return e instanceof Error?e.message||"unknown reason":`[coerced to error] ${String(e)}`}function J(e,t){return{schema:e,construct:t}}var Q="0.212.1";e.s(["CANCEL_CODE",()=>d,"ControlMessageHandshakeRequestSchema",()=>L,"ControlMessageHandshakeResponseSchema",()=>O,"Err",()=>w,"HandshakeErrorCustomHandlerFatalResponseCodes",()=>_,"HandshakeErrorRetriableResponseCodes",()=>U,"Ok",()=>v,"OpaqueTransportMessageSchema",()=>R,"UNEXPECTED_DISCONNECT_CODE",()=>h,"acceptedProtocolVersions",()=>M,"coerceErrorString",()=>X,"createClient",()=>z,"createClientHandshakeOptions",()=>J,"createConnectionTelemetryInfo",()=>V,"createSessionTelemetryInfo",()=>F,"currentProtocolVersion",()=>I,"generateId",()=>x,"getPropagationContext",()=>P,"getTracer",()=>q,"handshakeRequestMessage",()=>N,"handshakeResponseMessage",()=>$,"isAcceptedProtocolVersion",()=>B,"isAck",()=>H,"version",()=>Q],792129),e.s(["RIVER_VERSION",()=>Q],227062);var Y={debug:-1,info:0,warn:1,error:2},Z=e=>(t,n)=>{if(n&&!n.telemetry){let e=c.trace.getSpan(o.context.active());e&&(n.telemetry={traceId:e.spanContext().traceId,spanId:e.spanContext().spanId})}if(!n?.transportMessage)return void e(t,n);let{payload:i,...s}=n.transportMessage;n.transportMessage=s,e(t,n)},ee=class{minLevel;output;constructor(e,t="info"){this.minLevel=t,this.output=e}debug(e,t){Y[this.minLevel]<=Y.debug&&this.output(e,t??{},"debug")}info(e,t){Y[this.minLevel]<=Y.info&&this.output(e,t??{},"info")}warn(e,t){Y[this.minLevel]<=Y.warn&&this.output(e,t??{},"warn")}error(e,t){Y[this.minLevel]<=Y.error&&this.output(e,t??{},"error")}},et=e=>({debug:Z(e.debug.bind(e)),info:Z(e.info.bind(e)),warn:Z(e.warn.bind(e)),error:Z(e.error.bind(e))});e.s(["BaseLogger",()=>ee,"createLogProxy",()=>et],500137)},944661,e=>{"use strict";class t extends Error{constructor(e){super(e),Object.setPrototypeOf(this,Object.create(t.prototype)),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:t.name})}}e.s(["DecodeError",()=>t])},804422,e=>{"use strict";class t{constructor(e,t){this.type=e,this.data=t}}e.s(["ExtData",()=>t])},259535,256833,e=>{"use strict";var t=e.i(804422),n=e.i(944661);function i(e,t,n){e.setUint32(t,n/0x100000000),e.setUint32(t+4,n)}function s(e,t,n){let i=Math.floor(n/0x100000000);e.setUint32(t,i),e.setUint32(t+4,n)}function r(e,t){return 0x100000000*e.getInt32(t)+e.getUint32(t+4)}function o(e,t){return 0x100000000*e.getUint32(t)+e.getUint32(t+4)}e.s(["UINT32_MAX",0,0xffffffff,"getInt64",()=>r,"getUint64",()=>o,"setInt64",()=>s,"setUint64",()=>i],256833);let a={type:-1,encode:function(e){if(!(e instanceof Date))return null;{let t,n,i,r;return function({sec:e,nsec:t}){if(e>=0&&t>=0&&e<=0x3ffffffff)if(0===t&&e<=0xffffffff){let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e),t}else{let n=e/0x100000000,i=new Uint8Array(8),s=new DataView(i.buffer);return s.setUint32(0,t<<2|3&n),s.setUint32(4,0|e),i}{let n=new Uint8Array(12),i=new DataView(n.buffer);return i.setUint32(0,t),s(i,4,e),n}}((n=Math.floor((t=e.getTime())/1e3),r=Math.floor((i=(t-1e3*n)*1e6)/1e9),{sec:n+r,nsec:i-1e9*r}))}},decode:function(e){let t=function(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:{let e=t.getUint32(0);return{sec:(3&e)*0x100000000+t.getUint32(4),nsec:e>>>2}}case 12:return{sec:r(t,4),nsec:t.getUint32(0)};default:throw new n.DecodeError(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${e.length}`)}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}};class c{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(a)}register({type:e,encode:t,decode:n}){if(e>=0)this.encoders[e]=t,this.decoders[e]=n;else{let i=-1-e;this.builtInEncoders[i]=t,this.builtInDecoders[i]=n}}tryToEncode(e,n){for(let i=0;i<this.builtInEncoders.length;i++){let s=this.builtInEncoders[i];if(null!=s){let r=s(e,n);if(null!=r){let e=-1-i;return new t.ExtData(e,r)}}}for(let i=0;i<this.encoders.length;i++){let s=this.encoders[i];if(null!=s){let r=s(e,n);if(null!=r){let e=i;return new t.ExtData(e,r)}}}return e instanceof t.ExtData?e:null}decode(e,n,i){let s=n<0?this.builtInDecoders[-1-n]:this.decoders[n];return s?s(e,n,i):new t.ExtData(n,e)}}c.defaultCodec=new c,e.s(["ExtensionCodec",()=>c],259535)},926343,e=>{"use strict";function t(e){return`${e<0?"-":""}0x${Math.abs(e).toString(16).padStart(2,"0")}`}e.s(["prettyByte",()=>t])},726753,770663,e=>{"use strict";var t=e.i(926343),n=e.i(259535),i=e.i(256833);let s=new TextEncoder;function r(e,t,n){let i=t,s=i+n,r=[],o="";for(;i<s;){let t=e[i++];if((128&t)==0)r.push(t);else if((224&t)==192){let n=63&e[i++];r.push((31&t)<<6|n)}else if((240&t)==224){let n=63&e[i++],s=63&e[i++];r.push((31&t)<<12|n<<6|s)}else if((248&t)==240){let n=(7&t)<<18|(63&e[i++])<<12|(63&e[i++])<<6|63&e[i++];n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n)}else r.push(t);r.length>=4096&&(o+=String.fromCharCode(...r),r.length=0)}return r.length>0&&(o+=String.fromCharCode(...r)),o}let o=new TextDecoder;function a(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer||"u">typeof SharedArrayBuffer&&e instanceof SharedArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}var c=e.i(944661);let l="array",h="map_key",d="map_value",u=e=>{if("string"==typeof e||"number"==typeof e)return e;throw new c.DecodeError("The type of key must be string or number but "+typeof e)};class g{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){let t=this.getUninitializedStateFromPool();t.type=l,t.position=0,t.size=e,t.array=Array(e)}pushMapState(e){let t=this.getUninitializedStateFromPool();t.type=h,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){return this.stackHeadPosition++,this.stackHeadPosition===this.stack.length&&this.stack.push({type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null}),this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw Error("Invalid stack state. Released state is not on top of the stack.");e.type===l&&(e.size=0,e.array=void 0,e.position=0,e.type=void 0),(e.type===h||e.type===d)&&(e.size=0,e.map=void 0,e.readCount=0,e.type=void 0),this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}let f=new DataView(new ArrayBuffer(0)),p=new Uint8Array(f.buffer);try{f.getInt8(0)}catch(e){if(!(e instanceof RangeError))throw Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}let y=RangeError("Insufficient data"),m=new class{constructor(e=16,t=16){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let e=0;e<this.maxKeyLength;e++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,n){let i=this.caches[n-1];e:for(let s of i){let i=s.bytes;for(let s=0;s<n;s++)if(i[s]!==e[t+s])continue e;return s.str}return null}store(e,t){let n=this.caches[e.length-1],i={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=i:n.push(i)}decode(e,t,n){let i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;let s=r(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s}};class v{constructor(e){this.totalPos=0,this.pos=0,this.view=f,this.bytes=p,this.headByte=-1,this.stack=new g,this.entered=!1,this.extensionCodec=e?.extensionCodec??n.ExtensionCodec.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.rawStrings=e?.rawStrings??!1,this.maxStrLength=e?.maxStrLength??i.UINT32_MAX,this.maxBinLength=e?.maxBinLength??i.UINT32_MAX,this.maxArrayLength=e?.maxArrayLength??i.UINT32_MAX,this.maxMapLength=e?.maxMapLength??i.UINT32_MAX,this.maxExtLength=e?.maxExtLength??i.UINT32_MAX,this.keyDecoder=e?.keyDecoder!==void 0?e.keyDecoder:m,this.mapKeyConverter=e?.mapKeyConverter??u}clone(){return new v({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=-1,this.stack.reset()}setBuffer(e){let t=a(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(-1!==this.headByte||this.hasRemaining(1)){let t=this.bytes.subarray(this.pos),n=a(e),i=new Uint8Array(t.length+n.length);i.set(t),i.set(n,t.length),this.setBuffer(i)}else this.setBuffer(e)}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){let{view:t,pos:n}=this;return RangeError(`Extra ${t.byteLength-n} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);let t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){let t=this.clone();yield*t.decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{let n;this.entered=!0;let i=!1;for await(let t of e){if(i)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(t);try{n=this.doDecodeSync(),i=!0}catch(e){if(!(e instanceof RangeError))throw e}this.totalPos+=this.pos}if(i){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return n}let{headByte:s,pos:r,totalPos:o}=this;throw RangeError(`Insufficient data in parsing ${(0,t.prettyByte)(s)} at ${o} (${r} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async *decodeMultiAsync(e,t){if(this.entered){let n=this.clone();yield*n.decodeMultiAsync(e,t);return}try{this.entered=!0;let n=t,i=-1;for await(let s of e){if(t&&0===i)throw this.createExtraByteError(this.totalPos);this.appendBuffer(s),n&&(i=this.readArraySize(),n=!1,this.complete());try{for(;yield this.doDecodeSync(),0!=--i;);}catch(e){if(!(e instanceof RangeError))throw e}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){t:for(;;){let e,n=this.readHeadByte();if(n>=224)e=n-256;else if(n<192)if(n<128)e=n;else if(n<144){let t=n-128;if(0!==t){this.pushMapState(t),this.complete();continue}e={}}else if(n<160){let t=n-144;if(0!==t){this.pushArrayState(t),this.complete();continue}e=[]}else{let t=n-160;e=this.decodeString(t,0)}else if(192===n)e=null;else if(194===n)e=!1;else if(195===n)e=!0;else if(202===n)e=this.readF32();else if(203===n)e=this.readF64();else if(204===n)e=this.readU8();else if(205===n)e=this.readU16();else if(206===n)e=this.readU32();else if(207===n)e=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===n)e=this.readI8();else if(209===n)e=this.readI16();else if(210===n)e=this.readI32();else if(211===n)e=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===n){let t=this.lookU8();e=this.decodeString(t,1)}else if(218===n){let t=this.lookU16();e=this.decodeString(t,2)}else if(219===n){let t=this.lookU32();e=this.decodeString(t,4)}else if(220===n){let t=this.readU16();if(0!==t){this.pushArrayState(t),this.complete();continue}e=[]}else if(221===n){let t=this.readU32();if(0!==t){this.pushArrayState(t),this.complete();continue}e=[]}else if(222===n){let t=this.readU16();if(0!==t){this.pushMapState(t),this.complete();continue}e={}}else if(223===n){let t=this.readU32();if(0!==t){this.pushMapState(t),this.complete();continue}e={}}else if(196===n){let t=this.lookU8();e=this.decodeBinary(t,1)}else if(197===n){let t=this.lookU16();e=this.decodeBinary(t,2)}else if(198===n){let t=this.lookU32();e=this.decodeBinary(t,4)}else if(212===n)e=this.decodeExtension(1,0);else if(213===n)e=this.decodeExtension(2,0);else if(214===n)e=this.decodeExtension(4,0);else if(215===n)e=this.decodeExtension(8,0);else if(216===n)e=this.decodeExtension(16,0);else if(199===n){let t=this.lookU8();e=this.decodeExtension(t,1)}else if(200===n){let t=this.lookU16();e=this.decodeExtension(t,2)}else if(201===n){let t=this.lookU32();e=this.decodeExtension(t,4)}else throw new c.DecodeError(`Unrecognized type byte: ${(0,t.prettyByte)(n)}`);this.complete();let i=this.stack;for(;i.length>0;){let t=i.top();if(t.type===l)if(t.array[t.position]=e,t.position++,t.position===t.size)e=t.array,i.release(t);else continue t;else if(t.type===h){if("__proto__"===e)throw new c.DecodeError("The key __proto__ is not allowed");t.key=this.mapKeyConverter(e),t.type=d;continue t}else if(t.map[t.key]=e,t.readCount++,t.readCount===t.size)e=t.map,i.release(t);else{t.key=null,t.type=h;continue t}}return e}}readHeadByte(){return -1===this.headByte&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=-1}readArraySize(){let e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new c.DecodeError(`Unrecognized array type byte: ${(0,t.prettyByte)(e)}`)}}pushMapState(e){if(e>this.maxMapLength)throw new c.DecodeError(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new c.DecodeError(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){let n;if(e>this.maxStrLength)throw new c.DecodeError(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw y;let i=this.pos+t;return n=this.stateIsMapKey()&&this.keyDecoder?.canBeCached(e)?this.keyDecoder.decode(this.bytes,i,e):function(e,t,n){let i;if(!(n>200))return r(e,t,n);return i=e.subarray(t,t+n),o.decode(i)}(this.bytes,i,e),this.pos+=t+e,n}stateIsMapKey(){return this.stack.length>0&&this.stack.top().type===h}decodeBinary(e,t){if(e>this.maxBinLength)throw new c.DecodeError(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw y;let n=this.pos+t,i=this.bytes.subarray(n,n+e);return this.pos+=t+e,i}decodeExtension(e,t){if(e>this.maxExtLength)throw new c.DecodeError(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);let n=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,n,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){let e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){let e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){let e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){let e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){let e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){let e=(0,i.getUint64)(this.view,this.pos);return this.pos+=8,e}readI64(){let e=(0,i.getInt64)(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){let e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){let e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){let e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){let e=this.view.getFloat64(this.pos);return this.pos+=8,e}}function w(e,t){return new v(t).decode(e)}e.s(["decode",()=>w],726753);class S{constructor(e){this.entered=!1,this.extensionCodec=e?.extensionCodec??n.ExtensionCodec.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.maxDepth=e?.maxDepth??100,this.initialBufferSize=e?.initialBufferSize??2048,this.sortKeys=e?.sortKeys??!1,this.forceFloat32=e?.forceFloat32??!1,this.ignoreUndefined=e?.ignoreUndefined??!1,this.forceIntegerToFloat=e?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new S({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw Error(`Too deep objects in depth ${t}`);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.useBigInt64&&"bigint"==typeof e?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){let t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)}resizeBuffer(e){let t=new ArrayBuffer(e),n=new Uint8Array(t),i=new DataView(t);n.set(this.bytes),this.view=i,this.bytes=n}encodeNil(){this.writeU8(192)}encodeBoolean(e){!1===e?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<0x100000000?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-0x80000000?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<0x100000000)this.writeU8(219),this.writeU32(e);else throw Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let t=function(e){let t=e.length,n=0,i=0;for(;i<t;){let s=e.charCodeAt(i++);if((0xffffff80&s)==0){n++;continue}if((0xfffff800&s)==0)n+=2;else{if(s>=55296&&s<=56319&&i<t){let t=e.charCodeAt(i);(64512&t)==56320&&(++i,s=((1023&s)<<10)+(1023&t)+65536)}(0xffff0000&s)==0?n+=3:n+=4}}return n}(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),function(e,t,n){if(e.length>50)s.encodeInto(e,t.subarray(n));else!function(e,t,n){let i=e.length,s=n,r=0;for(;r<i;){let n=e.charCodeAt(r++);if((0xffffff80&n)==0){t[s++]=n;continue}if((0xfffff800&n)==0)t[s++]=n>>6&31|192;else{if(n>=55296&&n<=56319&&r<i){let t=e.charCodeAt(r);(64512&t)==56320&&(++r,n=((1023&n)<<10)+(1023&t)+65536)}(0xffff0000&n)==0?t[s++]=n>>12&15|224:(t[s++]=n>>18&7|240,t[s++]=n>>12&63|128),t[s++]=n>>6&63|128}t[s++]=63&n|128}}(e,t,n)}(e,this.bytes,this.pos),this.pos+=t}encodeObject(e,t){let n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if("object"==typeof e)this.encodeMap(e,t);else throw Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<0x100000000)this.writeU8(198),this.writeU32(t);else throw Error(`Too large binary: ${t}`);let n=a(e);this.writeU8a(n)}encodeArray(e,t){let n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else if(n<0x100000000)this.writeU8(221),this.writeU32(n);else throw Error(`Too large array: ${n}`);for(let n of e)this.doEncode(n,t+1)}countWithoutUndefined(e,t){let n=0;for(let i of t)void 0!==e[i]&&n++;return n}encodeMap(e,t){let n=Object.keys(e);this.sortKeys&&n.sort();let i=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<0x100000000)this.writeU8(223),this.writeU32(i);else throw Error(`Too large map object: ${i}`);for(let i of n){let n=e[i];this.ignoreUndefined&&void 0===n||(this.encodeString(i),this.doEncode(n,t+1))}}encodeExtension(e){if("function"==typeof e.data){let t=e.data(this.pos+6),n=t.length;if(n>=0x100000000)throw Error(`Too large extension object: ${n}`);this.writeU8(201),this.writeU32(n),this.writeI8(e.type),this.writeU8a(t);return}let t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<0x100000000)this.writeU8(201),this.writeU32(t);else throw Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),(0,i.setUint64)(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),(0,i.setInt64)(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}}function b(e,t){return new S(t).encodeSharedRef(e)}e.s(["encode",()=>b],770663)},627922,562563,e=>{"use strict";var t,n=e.i(792129),i=e.i(500137),s=e.i(619379),r=e.i(944661),o=e.i(259535),a=e.i(726753),c=e.i(770663),l=e.i(862927),h={RetriesExceeded:"conn_retry_exceeded",HandshakeFailed:"handshake_failed",MessageOrderingViolated:"message_ordering_violated",InvalidMessage:"invalid_message",MessageSendFailure:"message_send_failure"},d=class{eventListeners={};removeAllListeners(){this.eventListeners={}}numberOfListeners(e){return this.eventListeners[e]?.size??0}addEventListener(e,t){this.eventListeners[e]||(this.eventListeners[e]=new Set),this.eventListeners[e]?.add(t)}removeEventListener(e,t){this.eventListeners[e]&&this.eventListeners[e]?.delete(t)}dispatchEvent(e,t){let n=this.eventListeners[e];if(n)for(let e of[...n])e(t)}},u=new TextEncoder,g=new TextDecoder,f={heartbeatIntervalMs:1e3,heartbeatsUntilDead:2,sessionDisconnectGraceMs:5e3,connectionTimeoutMs:2e3,handshakeTimeoutMs:1e3,enableTransparentSessionReconnects:!0,codec:{toBuffer:e=>u.encode(JSON.stringify(e,function(e){let t=this[e];if(t instanceof Uint8Array){let e;return{$t:(e="",t.forEach(t=>{e+=String.fromCharCode(t)}),btoa(e))}}return"bigint"==typeof t?{$b:t.toString()}:t})),fromBuffer:e=>{let t=JSON.parse(g.decode(e),function(e,t){return t?.$t!==void 0?function(e){let t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}(t.$t):t?.$b!==void 0?BigInt(t.$b):t});if("object"!=typeof t||null===t)throw Error("unpacked msg is not an object");return t}}},p={...f,baseIntervalMs:150,maxJitterMs:200,maxBackoffMs:32e3,attemptBudgetCapacity:5,budgetRestoreIntervalMs:200,isFatalConnectionError:()=>!1},y=((t=y||{}).NoConnection="NoConnection",t.BackingOff="BackingOff",t.Connecting="Connecting",t.Handshaking="Handshaking",t.Connected="Connected",t.WaitingForHandshake="WaitingForHandshake",t),m="session state has been consumed and is no longer valid",v=class{_isConsumed;close(){this._handleClose()}constructor(){return this._isConsumed=!1,new Proxy(this,{get(e,t){if("_isConsumed"===t||"id"===t||"state"===t)return Reflect.get(e,t);if("_handleStateExit"===t)return()=>{e._isConsumed=!0,e._handleStateExit()};if("_handleClose"===t)return()=>{e._isConsumed=!0,e._handleStateExit(),e._handleClose()};if(e._isConsumed)throw Error(`${m}: getting ${t.toString()} on consumed state`);return Reflect.get(e,t)},set(e,t,n){if(e._isConsumed)throw Error(`${m}: setting ${t.toString()} on consumed state`);return Reflect.set(e,t,n)}})}},w=class extends v{from;options;codec;tracer;log;constructor({from:e,options:t,log:n,tracer:i,codec:s}){super(),this.from=e,this.options=t,this.log=n,this.tracer=i,this.codec=s}},S=class extends w{id;telemetry;to;protocolVersion;seq;seqSent;ack;sendBuffer;constructor(e){const{id:t,to:n,seq:i,ack:s,sendBuffer:r,telemetry:o,log:a,protocolVersion:c,seqSent:l}=e;super(e),this.id=t,this.to=n,this.seq=i,this.ack=s,this.sendBuffer=r,this.telemetry=o,this.log=a,this.protocolVersion=c,this.seqSent=l}get loggingMetadata(){let e={clientId:this.from,connectedTo:this.to,sessionId:this.id};if(this.telemetry.span.isRecording()){let t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}constructMsg(e){let t={...e,id:(0,n.generateId)(),to:this.to,from:this.from,seq:this.seq,ack:this.ack};return this.seq++,t}nextSeq(){return this.sendBuffer.length>0?this.sendBuffer[0].seq:this.seq}send(e){let t=this.constructMsg(e);return this.sendBuffer.push(t),{ok:!0,value:t.id}}_handleStateExit(){}_handleClose(){this.sendBuffer.length=0,this.telemetry.span.end()}},b=class extends S{graceExpiryTime;gracePeriodTimeout;listeners;constructor(e){super(e),this.listeners=e.listeners,this.graceExpiryTime=e.graceExpiryTime,this.gracePeriodTimeout=setTimeout(()=>{this.listeners.onSessionGracePeriodElapsed()},this.graceExpiryTime-Date.now())}_handleStateExit(){super._handleStateExit(),this.gracePeriodTimeout&&(clearTimeout(this.gracePeriodTimeout),this.gracePeriodTimeout=void 0)}_handleClose(){super._handleClose()}};function E(e,t,n){let i=t.toBuffer(n);return i.ok?e.send(i.value)?{ok:!0,value:n.id}:{ok:!1,reason:"failed to send message"}:i}var C=class extends b{state="Connecting";connPromise;listeners;connectionTimeout;constructor(e){super(e),this.connPromise=e.connPromise,this.listeners=e.listeners,this.connPromise.then(e=>{this._isConsumed||this.listeners.onConnectionEstablished(e)},e=>{this._isConsumed||this.listeners.onConnectionFailed(e)}),this.connectionTimeout=setTimeout(()=>{this.listeners.onConnectionTimeout()},this.options.connectionTimeoutMs)}bestEffortClose(){let e=this.log,t=this.loggingMetadata;this.connPromise.then(n=>{n.close(),e?.info("connection eventually resolved but session has transitioned, closed connection",{...t,...n.loggingMetadata})}).catch(()=>{})}_handleStateExit(){super._handleStateExit(),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0)}_handleClose(){super._handleClose(),this.bestEffortClose()}},x=class extends b{state="NoConnection";_handleClose(){super._handleClose()}_handleStateExit(){super._handleStateExit()}},T=class extends b{state="Handshaking";conn;listeners;handshakeTimeout;constructor(e){super(e),this.conn=e.conn,this.listeners=e.listeners,this.handshakeTimeout=setTimeout(()=>{this.listeners.onHandshakeTimeout()},this.options.handshakeTimeoutMs),this.conn.setDataListener(this.onHandshakeData),this.conn.setErrorListener(this.listeners.onConnectionErrored),this.conn.setCloseListener(this.listeners.onConnectionClosed)}get loggingMetadata(){return{...super.loggingMetadata,...this.conn.loggingMetadata}}onHandshakeData=e=>{let t=this.codec.fromBuffer(e);t.ok?this.listeners.onHandshake(t.value):this.listeners.onInvalidHandshake(`could not parse handshake message: ${t.reason}`,"MALFORMED_HANDSHAKE")};sendHandshake(e){return E(this.conn,this.codec,e)}_handleStateExit(){super._handleStateExit(),this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),this.handshakeTimeout&&(clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0)}_handleClose(){super._handleClose(),this.conn.close()}},k=class extends S{state="Connected";conn;listeners;heartbeatHandle;heartbeatMissTimeout;isActivelyHeartbeating=!1;updateBookkeeping(e,t){this.sendBuffer=this.sendBuffer.filter(t=>t.seq>=e),this.ack=t+1,this.heartbeatMissTimeout&&clearTimeout(this.heartbeatMissTimeout),this.startMissingHeartbeatTimeout()}assertSendOrdering(e){if(e.seq>this.seqSent+1){let t=`invariant violation: would have sent out of order msg (seq: ${e.seq}, expected: ${this.seqSent} + 1)`;throw this.log?.error(t,{...this.loggingMetadata,transportMessage:e,tags:["invariant-violation"]}),Error(t)}}send(e){let t=this.constructMsg(e);this.assertSendOrdering(t),this.sendBuffer.push(t);let n=E(this.conn,this.codec,t);return n.ok?this.seqSent=t.seq:this.listeners.onMessageSendFailure(t,n.reason),n}constructor(e){super(e),this.conn=e.conn,this.listeners=e.listeners,this.conn.setDataListener(this.onMessageData),this.conn.setCloseListener(this.listeners.onConnectionClosed),this.conn.setErrorListener(this.listeners.onConnectionErrored)}sendBufferedMessages(){if(this.sendBuffer.length>0)for(let e of(this.log?.info(`sending ${this.sendBuffer.length} buffered messages, starting at seq ${this.nextSeq()}`,this.loggingMetadata),this.sendBuffer)){this.assertSendOrdering(e);let t=E(this.conn,this.codec,e);if(!t.ok)return this.listeners.onMessageSendFailure(e,t.reason),t;this.seqSent=e.seq}return{ok:!0,value:void 0}}get loggingMetadata(){return{...super.loggingMetadata,...this.conn.loggingMetadata}}startMissingHeartbeatTimeout(){let e=this.options.heartbeatsUntilDead,t=e*this.options.heartbeatIntervalMs;this.heartbeatMissTimeout=setTimeout(()=>{this.log?.info(`closing connection to ${this.to} due to inactivity (missed ${e} heartbeats which is ${t}ms)`,this.loggingMetadata),this.telemetry.span.addEvent("closing connection due to missing heartbeat"),this.conn.close()},t)}startActiveHeartbeat(){this.isActivelyHeartbeating=!0,this.heartbeatHandle=setInterval(()=>{this.sendHeartbeat()},this.options.heartbeatIntervalMs)}sendHeartbeat(){this.log?.debug("sending heartbeat",this.loggingMetadata),this.send({streamId:"heartbeat",controlFlags:1,payload:{type:"ACK"}})}onMessageData=e=>{let t=this.codec.fromBuffer(e);if(!t.ok)return void this.listeners.onInvalidMessage(`could not parse message: ${t.reason}`);let i=t.value;if(i.seq!==this.ack){if(i.seq<this.ack)this.log?.debug(`received duplicate msg (got seq: ${i.seq}, wanted seq: ${this.ack}), discarding`,{...this.loggingMetadata,transportMessage:i});else{let e=`received out-of-order msg, closing connection (got seq: ${i.seq}, wanted seq: ${this.ack})`;this.log?.error(e,{...this.loggingMetadata,transportMessage:i,tags:["invariant-violation"]}),this.telemetry.span.setStatus({code:s.SpanStatusCode.ERROR,message:e}),this.conn.close()}return}(this.log?.debug("received msg",{...this.loggingMetadata,transportMessage:i}),this.updateBookkeeping(i.ack,i.seq),(0,n.isAck)(i.controlFlags))?(this.log?.debug("discarding msg (ack bit set)",{...this.loggingMetadata,transportMessage:i}),this.isActivelyHeartbeating||this.sendHeartbeat()):this.listeners.onMessage(i)};_handleStateExit(){super._handleStateExit(),this.conn.removeDataListener(),this.conn.removeCloseListener(),this.conn.removeErrorListener(),this.heartbeatHandle&&(clearInterval(this.heartbeatHandle),this.heartbeatHandle=void 0),this.heartbeatMissTimeout&&(clearTimeout(this.heartbeatMissTimeout),this.heartbeatMissTimeout=void 0)}_handleClose(){super._handleClose(),this.conn.close()}},I=class extends b{state="BackingOff";listeners;backoffTimeout;constructor(e){super(e),this.listeners=e.listeners,this.backoffTimeout=setTimeout(()=>{this.listeners.onBackoffFinished()},e.backoffMs)}_handleClose(){super._handleClose()}_handleStateExit(){super._handleStateExit(),this.backoffTimeout&&(clearTimeout(this.backoffTimeout),this.backoffTimeout=void 0)}},M=new o.ExtensionCodec;M.register({type:0,encode:e=>"bigint"!=typeof e?null:e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?(0,c.encode)(Number(e)):(0,c.encode)(String(e)),decode(e){let t=(0,a.decode)(e);if("string"!=typeof t&&"number"!=typeof t)throw new r.DecodeError(`unexpected BigInt source: ${typeof t}`);return BigInt(t)}});var B={toBuffer:e=>(0,c.encode)(e,{ignoreUndefined:!0,initialBufferSize:512,extensionCodec:M}),fromBuffer:e=>{let t=(0,a.decode)(e,{extensionCodec:M});if("object"!=typeof t||null===t)throw Error("unpacked msg is not an object");return t}},L=class{constructor(e){this.codec=e}toBuffer(e){try{return{ok:!0,value:this.codec.toBuffer(e)}}catch(e){return{ok:!1,reason:(0,n.coerceErrorString)(e)}}}fromBuffer(e){try{let t=this.codec.fromBuffer(e);if(!l.Value.Check(n.OpaqueTransportMessageSchema,t))return{ok:!1,reason:"transport message schema mismatch"};return{ok:!0,value:t}}catch(e){return{ok:!1,reason:(0,n.coerceErrorString)(e)}}}};function U(e){return{id:e.id,from:e.from,to:e.to,seq:e.seq,ack:e.ack,seqSent:e.seqSent,sendBuffer:e.sendBuffer,telemetry:e.telemetry,options:e.options,log:e.log,tracer:e.tracer,protocolVersion:e.protocolVersion,codec:e.codec}}function _(e){return{...U(e),graceExpiryTime:e.graceExpiryTime}}var A=(e,t,i,s,r,o,a)=>{let c=`session-${(0,n.generateId)()}`,l=(0,n.createSessionTelemetryInfo)(o,c,e,t),h=new x({listeners:i,id:c,from:t,to:e,seq:0,ack:0,seqSent:0,graceExpiryTime:Date.now()+s.sessionDisconnectGraceMs,sendBuffer:[],telemetry:l,options:s,protocolVersion:r,tracer:o,log:a,codec:new L(s.codec)});return h.log?.info(`session ${h.id} created in NoConnection state`,{...h.loggingMetadata,tags:["state-transition"]}),h},D={NoConnectionToBackingOff:(e,t,n)=>{let i=_(e);e._handleStateExit();let s=new I({backoffMs:t,listeners:n,...i});return s.log?.info(`session ${s.id} transition from NoConnection to BackingOff`,{...s.loggingMetadata,tags:["state-transition"]}),s},BackingOffToConnecting:(e,t,n)=>{let i=_(e);e._handleStateExit();let s=new C({connPromise:t,listeners:n,...i});return s.log?.info(`session ${s.id} transition from BackingOff to Connecting`,{...s.loggingMetadata,tags:["state-transition"]}),s},ConnectingToHandshaking:(e,t,i)=>{let s=_(e);e._handleStateExit();let r=new T({conn:t,listeners:i,...s});return t.telemetry=(0,n.createConnectionTelemetryInfo)(r.tracer,t,r.telemetry),r.log?.info(`session ${r.id} transition from Connecting to Handshaking`,{...r.loggingMetadata,tags:["state-transition"]}),r},HandshakingToConnected:(e,t)=>{let n=U(e),i=e.conn;e._handleStateExit();let s=new k({conn:i,listeners:t,...n});return s.startMissingHeartbeatTimeout(),s.log?.info(`session ${s.id} transition from Handshaking to Connected`,{...s.loggingMetadata,tags:["state-transition"]}),s},WaitingForHandshakeToConnected:(e,t,i,s,r,o,a)=>{let c=e.conn,{from:l,options:h}=e,d=t?U(t):{id:i,from:l,to:s,seq:0,ack:0,seqSent:0,sendBuffer:[],telemetry:(0,n.createSessionTelemetryInfo)(e.tracer,i,s,l,r),options:h,tracer:e.tracer,log:e.log,protocolVersion:a,codec:new L(h.codec)};e._handleStateExit(),t?._handleStateExit();let u=new k({conn:c,listeners:o,...d});return u.startMissingHeartbeatTimeout(),c.telemetry=(0,n.createConnectionTelemetryInfo)(u.tracer,c,u.telemetry),u.log?.info(`session ${u.id} transition from WaitingForHandshake to Connected`,{...u.loggingMetadata,tags:["state-transition"]}),u},BackingOffToNoConnection:(e,t)=>{let n=_(e);e._handleStateExit();let i=new x({listeners:t,...n});return i.log?.info(`session ${i.id} transition from BackingOff to NoConnection`,{...i.loggingMetadata,tags:["state-transition"]}),i},ConnectingToNoConnection:(e,t)=>{let n=_(e);e.bestEffortClose(),e._handleStateExit();let i=new x({listeners:t,...n});return i.log?.info(`session ${i.id} transition from Connecting to NoConnection`,{...i.loggingMetadata,tags:["state-transition"]}),i},HandshakingToNoConnection:(e,t)=>{let n=_(e);e.conn.close(),e._handleStateExit();let i=new x({listeners:t,...n});return i.log?.info(`session ${i.id} transition from Handshaking to NoConnection`,{...i.loggingMetadata,tags:["state-transition"]}),i},ConnectedToNoConnection:(e,t)=>{let n=U(e),i=Date.now()+e.options.sessionDisconnectGraceMs;e.conn.close(),e._handleStateExit();let s=new x({listeners:t,graceExpiryTime:i,...n});return s.log?.info(`session ${s.id} transition from Connected to NoConnection`,{...s.loggingMetadata,tags:["state-transition"]}),s}},O={entrypoint:A,transition:{NoConnectionToBackingOff:D.NoConnectionToBackingOff,BackingOffToConnecting:D.BackingOffToConnecting,ConnectingToHandshaking:D.ConnectingToHandshaking,HandshakingToConnected:D.HandshakingToConnected,BackingOffToNoConnection:D.BackingOffToNoConnection,ConnectingToNoConnection:D.ConnectingToNoConnection,HandshakingToNoConnection:D.HandshakingToNoConnection,ConnectedToNoConnection:D.ConnectedToNoConnection}},R=(D.WaitingForHandshakeToConnected,D.ConnectedToNoConnection,class{status;clientId;eventDispatcher;options;log;tracer;sessions;constructor(e,t){this.options={...f,...t},this.eventDispatcher=new d,this.clientId=e,this.status="open",this.sessions=new Map,this.tracer=(0,n.getTracer)()}bindLogger(e,t){if("function"==typeof e){this.log=(0,i.createLogProxy)(new i.BaseLogger(e,t));return}this.log=(0,i.createLogProxy)(e)}handleMsg(e){"open"===this.getStatus()&&this.eventDispatcher.dispatchEvent("message",e)}addEventListener(e,t){this.eventDispatcher.addEventListener(e,t)}removeEventListener(e,t){this.eventDispatcher.removeEventListener(e,t)}protocolError(e){this.eventDispatcher.dispatchEvent("protocolError",e)}close(){for(let e of(this.status="closed",Array.from(this.sessions.values())))this.deleteSession(e);this.eventDispatcher.dispatchEvent("transportStatus",{status:this.status}),this.eventDispatcher.removeAllListeners(),this.log?.info("manually closed transport",{clientId:this.clientId})}getStatus(){return this.status}createSession(e){let t=this.sessions.get(e.to);if(t){let n=`attempt to create session for ${e.to} but active session (${t.id}) already exists`;throw this.log?.error(n,{...e.loggingMetadata,tags:["invariant-violation"]}),Error(n)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"created",session:e}),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}updateSession(e){let t=this.sessions.get(e.to);if(!t){let t=`attempt to transition session for ${e.to} but no active session exists`;throw this.log?.error(t,{...e.loggingMetadata,tags:["invariant-violation"]}),Error(t)}if(t.id!==e.id){let n=`attempt to transition active session for ${e.to} but active session (${t.id}) is different from handle (${e.id})`;throw this.log?.error(n,{...e.loggingMetadata,tags:["invariant-violation"]}),Error(n)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}deleteSession(e,t){if(e._isConsumed)return;let n=e.loggingMetadata;n.tags&&t?.unhealthy&&n.tags.push("unhealthy-session"),e.log?.info(`closing session ${e.id}`,n),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closing",session:e});let i=e.to;e.close(),this.sessions.delete(i),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closed",session:{id:e.id,to:i}})}onSessionGracePeriodElapsed(e){this.log?.info(`session to ${e.to} grace period elapsed, closing`,e.loggingMetadata),this.deleteSession(e)}onConnectingFailed(e){let t=D.ConnectingToNoConnection(e,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}});return this.updateSession(t),t}onConnClosed(e){let t;return t="Handshaking"===e.state?D.HandshakingToNoConnection(e,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}}):D.ConnectedToNoConnection(e,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}}),this.updateSession(t),t}getSessionBoundSendFn(e,t){if("open"!==this.getStatus())throw Error("cannot get a bound send function on a closed transport");return n=>{let i=this.sessions.get(e);if(!i)throw Error(`session scope for ${t} has ended (close), can't send`);if(i.id!==t||i._isConsumed)throw Error(`session scope for ${t} has ended (transition), can't send`);let s=i.send(n);if(!s.ok)throw Error(s.reason);return s.value}}}),N=class{budgetConsumed;intervalHandle;options;constructor(e){this.options=e,this.budgetConsumed=0}getBackoffMs(){if(0===this.getBudgetConsumed())return 0;let e=Math.max(0,this.getBudgetConsumed()-1),t=Math.floor(Math.random()*this.options.maxJitterMs);return Math.min(this.options.baseIntervalMs*2**e,this.options.maxBackoffMs)+t}get totalBudgetRestoreTime(){return this.options.budgetRestoreIntervalMs*this.options.attemptBudgetCapacity}consumeBudget(){this.stopLeak(),this.budgetConsumed=this.getBudgetConsumed()+1}getBudgetConsumed(){return this.budgetConsumed}hasBudget(){return this.getBudgetConsumed()<this.options.attemptBudgetCapacity}startRestoringBudget(){if(this.intervalHandle)return;let e=()=>{let e=this.budgetConsumed;if(!e)return void this.stopLeak();let t=e-1;0!==t&&(this.budgetConsumed=t)};this.intervalHandle=setInterval(e,this.options.budgetRestoreIntervalMs)}stopLeak(){this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=void 0)}close(){this.stopLeak()}},$=class extends R{options;retryBudget;reconnectOnConnectionDrop=!0;handshakeExtensions;sessions;constructor(e,t){super(e,t),this.sessions=new Map,this.options={...p,...t},this.retryBudget=new N(this.options)}extendHandshake(e){this.handshakeExtensions=e}tryReconnecting(e){let t=this.sessions.get(e);!this.options.enableTransparentSessionReconnects&&t&&this.deleteSession(t),this.reconnectOnConnectionDrop&&"open"===this.getStatus()&&this.connect(e)}createUnconnectedSession(e){let t=O.entrypoint(e,this.clientId,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}},this.options,n.currentProtocolVersion,this.tracer,this.log);return this.createSession(t),t}onConnectingFailed(e){let t=super.onConnectingFailed(e);return this.tryReconnecting(t.to),t}onConnClosed(e){let t=super.onConnClosed(e);return this.tryReconnecting(t.to),t}onConnectionEstablished(e,t){let i=O.transition.ConnectingToHandshaking(e,t,{onConnectionErrored:e=>{let t=(0,n.coerceErrorString)(e);this.log?.error(`connection to ${i.to} errored during handshake: ${t}`,i.loggingMetadata)},onConnectionClosed:()=>{this.log?.warn(`connection to ${i.to} closed during handshake`,i.loggingMetadata),this.onConnClosed(i)},onHandshake:e=>{this.onHandshakeResponse(i,e)},onInvalidHandshake:(t,n)=>{this.log?.error(`invalid handshake: ${t}`,i.loggingMetadata),this.deleteSession(e,{unhealthy:!0}),this.protocolError({type:h.HandshakeFailed,code:n,message:t})},onHandshakeTimeout:()=>{this.log?.error(`connection to ${i.to} timed out during handshake`,i.loggingMetadata),this.onConnClosed(i)},onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(i)}});return this.updateSession(i),this.sendHandshake(i),i}rejectHandshakeResponse(e,t,n){e.conn.telemetry?.span.setStatus({code:s.SpanStatusCode.ERROR,message:t}),this.log?.warn(t,n),this.deleteSession(e,{unhealthy:!0})}onHandshakeResponse(e,t){if(!l.Value.Check(n.ControlMessageHandshakeResponseSchema,t.payload))return void this.rejectHandshakeResponse(e,"received invalid handshake response",{...e.loggingMetadata,transportMessage:t,validationErrors:[...l.Value.Errors(n.ControlMessageHandshakeResponseSchema,t.payload)]});if(!t.payload.status.ok){let i=l.Value.Check(n.HandshakeErrorRetriableResponseCodes,t.payload.status.code),s=`handshake failed: ${t.payload.status.reason}`,r=e.to;this.rejectHandshakeResponse(e,s,{...e.loggingMetadata,transportMessage:t}),i?this.tryReconnecting(r):this.protocolError({type:h.HandshakeFailed,code:t.payload.status.code,message:s});return}if(t.payload.status.sessionId!==e.id){let n=`session id mismatch: expected ${e.id}, got ${t.payload.status.sessionId}`;this.rejectHandshakeResponse(e,n,{...e.loggingMetadata,transportMessage:t});return}this.log?.info(`handshake from ${t.from} ok`,{...e.loggingMetadata,transportMessage:t});let i=O.transition.HandshakingToConnected(e,{onConnectionErrored:e=>{let t=(0,n.coerceErrorString)(e);e instanceof Error&&this.options.isFatalConnectionError(e)?(this.log?.warn(`connection to ${i.to} fatally errored: ${t}`,i.loggingMetadata),this.reconnectOnConnectionDrop=!1):this.log?.warn(`connection to ${i.to} errored: ${t}`,i.loggingMetadata)},onConnectionClosed:()=>{this.log?.info(`connection to ${i.to} closed`,i.loggingMetadata),this.onConnClosed(i)},onMessage:e=>{this.handleMsg(e)},onInvalidMessage:e=>{this.log?.error(`invalid message: ${e}`,{...i.loggingMetadata,transportMessage:t}),this.protocolError({type:h.InvalidMessage,message:e}),this.deleteSession(i,{unhealthy:!0})},onMessageSendFailure:(e,t)=>{this.log?.error(`failed to send message: ${t}`,{...i.loggingMetadata,transportMessage:e}),this.protocolError({type:h.MessageSendFailure,message:t}),this.deleteSession(i,{unhealthy:!0})}});i.sendBufferedMessages().ok&&(this.updateSession(i),this.retryBudget.startRestoringBudget())}connect(e){if("open"!==this.getStatus())return void this.log?.info(`transport state is no longer open, cancelling attempt to connect to ${e}`);let t=this.sessions.get(e)??this.createUnconnectedSession(e);if("NoConnection"!==t.state)return void this.log?.debug(`session to ${e} has state ${t.state}, skipping connect attempt`,t.loggingMetadata);if(!this.retryBudget.hasBudget()){let n=this.retryBudget.getBudgetConsumed(),i=`tried to connect to ${e} but retry budget exceeded (more than ${n} attempts in the last ${this.retryBudget.totalBudgetRestoreTime}ms)`;this.log?.error(i,t.loggingMetadata),this.protocolError({type:h.RetriesExceeded,message:i});return}let n=this.retryBudget.getBackoffMs();this.log?.info(`attempting connection to ${e} (${n}ms backoff)`,t.loggingMetadata),this.retryBudget.consumeBudget();let i=O.transition.NoConnectionToBackingOff(t,n,{onBackoffFinished:()=>{this.onBackoffFinished(i)},onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(i)}});this.updateSession(i)}hardDisconnect(){for(let e of Array.from(this.sessions.values()))this.deleteSession(e)}onBackoffFinished(e){let t=e.tracer.startActiveSpan("connect",async t=>{try{return await this.createNewOutgoingConnection(e.to)}catch(i){let e=(0,n.coerceErrorString)(i);throw t.recordException(e),t.setStatus({code:s.SpanStatusCode.ERROR}),i}finally{t.end()}}),i=O.transition.BackingOffToConnecting(e,t,{onConnectionEstablished:e=>{this.log?.debug(`connection to ${i.to} established`,{...e.loggingMetadata,...i.loggingMetadata}),this.onConnectionEstablished(i,e)},onConnectionFailed:e=>{let t=(0,n.coerceErrorString)(e);this.log?.error(`error connecting to ${i.to}: ${t}`,i.loggingMetadata),this.onConnectingFailed(i)},onConnectionTimeout:()=>{this.log?.error(`connection to ${i.to} timed out`,i.loggingMetadata),this.onConnectingFailed(i)},onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(i)}});this.updateSession(i)}async sendHandshake(e){let t;if(this.handshakeExtensions)try{t=await this.handshakeExtensions.construct()}catch(i){let t=(0,n.coerceErrorString)(i);this.log?.error(`failed to construct handshake metadata for session to ${e.to}: ${t}`,e.loggingMetadata),this.protocolError({type:h.HandshakeFailed,message:`failed to construct handshake metadata: ${t}`}),this.deleteSession(e,{unhealthy:!0});return}if(e._isConsumed)return;let i=(0,n.handshakeRequestMessage)({from:this.clientId,to:e.to,sessionId:e.id,expectedSessionState:{nextExpectedSeq:e.ack,nextSentSeq:e.nextSeq()},metadata:t,tracing:(0,n.getPropagationContext)(e.telemetry.ctx)});this.log?.debug(`sending handshake request to ${e.to}`,{...e.loggingMetadata,transportMessage:i});let s=e.sendHandshake(i);s.ok||(this.log?.error(`failed to send handshake request: ${s.reason}`,{...e.loggingMetadata,transportMessage:i}),this.protocolError({type:h.MessageSendFailure,message:s.reason}),this.deleteSession(e,{unhealthy:!0}))}close(){this.retryBudget.close(),super.close()}},H=class{id;telemetry;constructor(){this.id=`conn-${(0,n.generateId)()}`}get loggingMetadata(){let e={connId:this.id};if(this.telemetry?.span.isRecording()){let t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}dataListener;closeListener;errorListener;onData(e){this.dataListener?.(e)}onError(e){this.errorListener?.(e)}onClose(){this.closeListener?.(),this.telemetry?.span.end()}setDataListener(e){this.dataListener=e}removeDataListener(){this.dataListener=void 0}setCloseListener(e){this.closeListener=e}removeCloseListener(){this.closeListener=void 0}setErrorListener(e){this.errorListener=e}removeErrorListener(){this.errorListener=void 0}},P=class extends Error{code;reason;constructor(e,t){super(`websocket closed with code and reason: ${e} - ${t}`),this.code=e,this.reason=t}},F=class extends H{ws;extras;get loggingMetadata(){let e=super.loggingMetadata;return this.extras&&(e.extras=this.extras),e}constructor(e,t){super(),this.ws=e,this.extras=t,this.ws.binaryType="arraybuffer";let n=!1;this.ws.onerror=()=>{n=!0},this.ws.onclose=({code:e,reason:t})=>{if(n){let n=new P(e,t);this.onError(n)}this.onClose()},this.ws.onmessage=e=>{this.onData(e.data)}}send(e){try{return this.ws.send(e),!0}catch{return!1}}close(){this.ws.close(1e3)}};e.s(["BinaryCodec",()=>B,"ClientTransport",()=>$,"ProtocolError",()=>h,"WebSocketCloseError",()=>P,"WebSocketConnection",()=>F],627922);var V=class extends ${wsGetter;constructor(e,t,n){super(t,n),this.wsGetter=e}async createNewOutgoingConnection(e){this.log?.info(`establishing a new websocket to ${e}`,{clientId:this.clientId,connectedTo:e});let t=await this.wsGetter(e);await new Promise((e,n)=>{t.readyState===t.OPEN?e():t.readyState===t.CLOSING||t.readyState===t.CLOSED?n(Error("ws is closing or closed")):(t.onopen=()=>{e()},t.onclose=e=>{n(Error(e.reason))},t.onerror=e=>{n(Error(e.message))})});let n=new F(t);return this.log?.info(`raw websocket to ${e} ok`,{clientId:this.clientId,connectedTo:e,...n.loggingMetadata}),n}};e.s(["WebSocketClientTransport",()=>V],562563)},386962,e=>{"use strict";e.i(977195);var t=e.i(590467);function n(e){let{transport:n,logContext:i,serverId:s,isClientActiveObservable:r,onRetryBudgetExhausted:o,onProtocolError:a,onSessionStatusChange:c,log:l}=e,h=i.target,d={},u=new Set;function g(){n.reconnectOnConnectionDrop=!0,l?.(`${h}: attempting connection`,{clientId:n.clientId}),n.connect(s)}function f(){l?.(`${h}: disabling reconnect`,{clientId:n.clientId}),n.reconnectOnConnectionDrop=!1}let p=e=>{let t=e.status;if("created"===t||"connect"===t){u.add(e.session.id),l?.(`${h}: session created`,{clientId:n.clientId,sessionId:e.session.id}),c?.("created",e.session.id);return}if("closed"===t||"disconnect"===t){u.has(e.session.id)&&"closed"!==n.getStatus()&&l?.(`${h}: detected zombie session`,{clientId:n.clientId,sessionId:e.session.id},"error"),u.delete(e.session.id),l?.(`${h}: session closed`,{clientId:n.clientId,sessionId:e.session.id}),c?.("closed",e.session.id),setTimeout(()=>{r.current&&"open"===n.getStatus()&&n.reconnectOnConnectionDrop&&g()},0);return}},y=e=>{let t="id"in e?e.id:n.sessions.get(s)?.id;"NoConnection"!==e.state&&t&&u.delete(t),"Connecting"===e.state&&(d.connectionStart=Date.now(),l?.(`${h}: connecting`,{sessionId:t,clientId:n.clientId})),"Handshaking"===e.state&&(d.handshakeStart=Date.now()),"Connected"===e.state&&d.connectionStart&&d.handshakeStart&&(l?.(`${h}: connected`,{sessionId:t,clientId:n.clientId,extras:{...d,connectionDuration:d.handshakeStart-d.connectionStart,handshakeDuration:Date.now()-d.handshakeStart,totalDuration:Date.now()-d.connectionStart}}),d.connectionStart=void 0,d.handshakeStart=void 0),"NoConnection"===e.state&&(l?.(`${h}: no connection`,{sessionId:t,clientId:n.clientId}),d.connectionStart=void 0,d.handshakeStart=void 0)},m=e=>{if("conn_retry_exceeded"===e.type){l?.(`${h}: retry budget exhausted`,{evt:e},"warn"),f(),n.retryBudget.startRestoringBudget(),r.current&&o?.();return}l?.(`${h}: protocol error`,{evt:e},"error"),a?.(e),n.close()};function v(){g()}n.addEventListener("protocolError",m),n.addEventListener("sessionStatus",p),n.addEventListener("sessionTransition",y),window.addEventListener("online",v),window.addEventListener("offline",f),(0,t.isBrowserOnline)()&&g();let w=r.current,S=r.subscribe(e=>{l?.(`${h}: isClientActive changed`,{prevIsActive:w,isClientActive:e,clientId:n.clientId}),!w&&e&&(l?.(`${h}: client became active, attempting connection`,{clientId:n.clientId}),g()),w=e});return{transport:n,dispose:()=>{n.removeEventListener("sessionStatus",p),n.removeEventListener("sessionTransition",y),n.removeEventListener("protocolError",m),n.close(),S(),window.removeEventListener("online",v),window.removeEventListener("offline",f)},connect:g}}e.s(["setupRiverTransport",()=>n])},289074,e=>{"use strict";var t=e.i(541793);let n=(0,t.atom)({pid2:"ok","ai-chat":"ok",chort:"ok",pid1:"ok"}),i=(0,t.atom)({pid2:null,"ai-chat":null,chort:null,pid1:null}),s=(0,t.atom)(e=>Object.values(e(n)).some(e=>"fatal"===e));(0,t.atom)(e=>Object.entries(e(n)).filter(([,e])=>"fatal"===e).map(([e])=>e)),e.s(["connectionKillActionsAtom",0,i,"connectionStateAtom",0,n,"hasDeadServiceAtom",0,s])}]);

//# debugId=a6d94eec-cdf2-613a-b5ea-0cbbddfeb109
//# sourceMappingURL=0cbfa7dbd8ad8b43.js.map